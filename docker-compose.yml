services:
  redis:
    image: redis:7-alpine
    command: redis-server --appendonly yes
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  api:
    build:
      context: ./api
    ports:
      - "8080:8080"
    environment:
      - REDIS_ADDR=redis:6379
      - PORT=8080
      - TASK_MAX_RETRY=2
      - TASK_TIMEOUT_MINUTES=30
      - TASK_RETENTION_HOURS=24
    depends_on:
      - redis

  worker:
    build:
      context: ./worker
    environment:
      - REDIS_ADDR=redis:6379
      - WORK_DIR=/tmp/ffmpeg-jobs
      - CONCURRENCY=2
      - WEBHOOK_MAX_RETRY=5
      - WEBHOOK_RETENTION_HOURS=72
      # Resource monitoring (prevents OOM by delaying jobs when memory is high)
      - RESOURCE_CHECK_ENABLED=true
      - MAX_MEMORY_PERCENT=85
      # Storage adapter (default: file)
      - STORAGE_ADAPTER=file
      - OUTPUT_DIR=/output
      # - STORAGE_BASE_URL=https://cdn.example.com
      # Bunny Storage (uncomment to use)
      # - STORAGE_ADAPTER=bunny-storage
      # - BUNNY_STORAGE_ZONE=my-zone
      # - BUNNY_STORAGE_KEY=secret
      # - BUNNY_STORAGE_ENDPOINT=storage.bunnycdn.com
      # - BUNNY_STORAGE_PATH_PREFIX=outputs/
      # - BUNNY_STORAGE_PULL_ZONE_URL=https://my-zone.b-cdn.net
      # Bunny Stream (uncomment to use)
      # - STORAGE_ADAPTER=bunny-stream
      # - BUNNY_STREAM_LIBRARY_ID=12345
      # - BUNNY_STREAM_API_KEY=secret
      # S3 (uncomment to use)
      # - STORAGE_ADAPTER=s3
      # - S3_BUCKET=my-bucket
      # - S3_REGION=us-east-1
      # - S3_ACCESS_KEY=xxx
      # - S3_SECRET_KEY=xxx
      # - S3_ENDPOINT=https://s3.example.com
      # - S3_PATH_PREFIX=outputs/
      # - S3_PUBLIC_URL=https://cdn.example.com
    volumes:
      - ./output:/output
    depends_on:
      - redis

  webhooks:
    build:
      context: ./webhooks
    ports:
      - "8081:8081"
    environment:
      - REDIS_ADDR=redis:6379
      - CONCURRENCY=10
      - HTTP_TIMEOUT=10
      - MAX_RETRY=5
      - RETENTION_HOURS=72
      - HEALTH_PORT=8081
    depends_on:
      - redis

volumes:
  redis-data:
